name: Release

on:
    push:
        tags:
            - "v*" # Triggers on version tags like v1.0.0, v2.1.3, etc.

permissions:
    contents: write # Required for creating releases

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                # Build for multiple platforms
                include:
                    - goos: linux
                      goarch: amd64
                      suffix: linux-amd64
                    - goos: linux
                      goarch: arm64
                      suffix: linux-arm64
                    - goos: windows
                      goarch: amd64
                      suffix: windows-amd64.exe
                    - goos: darwin
                      goarch: amd64
                      suffix: darwin-amd64
                    - goos: darwin
                      goarch: arm64
                      suffix: darwin-arm64

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.21"
                  cache: true # Enable Go module caching

            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Download dependencies
              run: go mod download

            - name: Verify dependencies
              run: go mod verify

            - name: Run tests
              run: go test -v ./...

            - name: Build binary
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
                  CGO_ENABLED: 0
              run: |
                  binary_name="mediawiki-updater-${{ matrix.suffix }}"
                  go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o "$binary_name" .

                  # Create a compressed archive
                  if [[ "${{ matrix.goos }}" == "windows" ]]; then
                    zip "${binary_name%.exe}.zip" "$binary_name"
                    echo "ASSET_NAME=${binary_name%.exe}.zip" >> $GITHUB_ENV
                  else
                    tar -czf "${binary_name}.tar.gz" "$binary_name"
                    echo "ASSET_NAME=${binary_name}.tar.gz" >> $GITHUB_ENV
                  fi

                  echo "BINARY_NAME=$binary_name" >> $GITHUB_ENV

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.ASSET_NAME }}
                  path: ${{ env.ASSET_NAME }}

    create-release:
        needs: build-and-release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./artifacts

            - name: Display structure of downloaded files
              run: ls -la ./artifacts

            - name: Generate Release Notes
              id: release_notes
              run: |
                cat > release_notes.md << 'EOF'
                ## Changes in ${{ github.ref_name }}
                
                ### ðŸš€ Installation
                
                Download the appropriate binary for your platform:
                
                - **Linux (x64)**: `mediawiki-updater-linux-amd64.tar.gz`
                - **Linux (ARM64)**: `mediawiki-updater-linux-arm64.tar.gz`
                - **macOS (Intel)**: `mediawiki-updater-darwin-amd64.tar.gz`
                - **macOS (Apple Silicon)**: `mediawiki-updater-darwin-arm64.tar.gz`
                - **Windows (x64)**: `mediawiki-updater-windows-amd64.zip`
                
                ### ðŸ“– Quick Start
                
                ```bash
                # Linux/macOS
                tar -xzf mediawiki-updater-*.tar.gz
                chmod +x mediawiki-updater-*
                ./mediawiki-updater-* --help
                
                # Windows
                # Extract the ZIP file and run mediawiki-updater-windows-amd64.exe
                ```
                
                ### ðŸ“ Configuration
                
                Create an `config.ini` file:
                
                ```ini
                [mediawiki]
                version=1.43.1
                
                [extensions]
                extdist1=VisualEditor
                extdist2=WikiEditor
                
                [skins]
                extdist1=Vector
                ```
                
                For full documentation, see the [README](https://github.com/${{ github.repository }}/blob/main/README.md).
                EOF

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                name: Release ${{ github.ref_name }}
                body_path: release_notes.md
                files: |
                  ./artifacts/*/*
                draft: false
                prerelease: false
                generate_release_notes: true
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
